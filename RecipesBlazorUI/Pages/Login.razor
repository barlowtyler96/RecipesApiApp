@page "/login"
@using System.Net.Http.Json
@inject IHttpClientFactory factory
@inject TokenModel tokenInfo

<PageTitle>Login</PageTitle>


<div class="container-fluid justify-content-center">
	@if (isLoggedIn)
	{
		<div class="h1">Log Out</div>
		<button class="btn btn-danger" @onclick="LogOut">Log Out</button>
	}
	else
	{
		<div class="h1">Please Log In</div>
		<EditForm Model="login" OnValidSubmit="HandleValidSubmit">
			<InputText @bind-Value="login.UserName" />
			<div class="form-text">Username</div>
			<InputText type="password" @bind-Value="login.Password" />
			<div class="form-text">Password</div>
			<button class="btn btn-success" type="submit">Log In</button>
		</EditForm>
	}
</div>


@code {
	private AuthenticationModel login = new();
	private bool isLoggedIn = false;

	protected override void OnInitialized()
	{
		isLoggedIn = !string.IsNullOrWhiteSpace(tokenInfo.Token);
	}

	private async void HandleValidSubmit()
	{
		var client = factory.CreateClient("api"); //named this in program.cs

		var info = await client.PostAsJsonAsync<AuthenticationModel>("Authentication/token", login);

		tokenInfo.Token = await info.Content.ReadAsStringAsync();
		isLoggedIn = true;
		await InvokeAsync(StateHasChanged);
	}

	private void LogOut()
	{
		tokenInfo.Token = "";
		isLoggedIn = false;
	}
}
