@page "/submit"
@using System.Net.Http.Json
@using System.Net.Http.Headers
@inject IHttpClientFactory factory
@inject TokenModel tokenInfo
<PageTitle>Create</PageTitle>

<h3>Create</h3>



<div class="container-fluid">
    <EditForm Model=@recipe OnValidSubmit="SubmitRecipe">
        <DataAnnotationsValidator/>
        <div class="form-group mb-3">
            <label for="Name">Recipe Name</label>
            <InputText @bind-Value=recipe.Name class="form-control" id="Name" />
            <ValidationMessage For="@(() => recipe.Name)" />
            <div class="form-text">Please capitalize the first letter of each word. (ex: Pepperoni Pizza)</div>
        </div>
        <div class="form-group mb-3">
            <label for="Description">Recipe Description</label>
            <InputText @bind-Value=recipe.Description class="form-control" id="Description" />
            <ValidationMessage For="@(() => recipe.Description)" />
            <div class="form-text">Please capitalize and use periods on a new sentence. Like this.</div>
        </div>
        <div class="form-group mb-3">
            <label for="Ingredients">Recipe Ingredients</label>
            <InputText @bind-Value=recipe.Ingredients class="form-control" id="Ingredients" />
            <ValidationMessage For="@(() => recipe.Ingredients)" />
            <div class="form-text">Please put a '-' between each ingredient. (ex: 1 cup flour - 1 egg).</div>
        </div>
        <div class="form-group mb-3">
            <label for="Instructions">Recipe Instructions</label>
            <InputText @bind-Value=recipe.Instructions class="form-control" id="Instructions" />
            <ValidationMessage For="@(() => recipe.Instructions)" />
            <div class="form-text">Please capitalize and use periods on a new sentence. Like this.</div>
        </div>
        <input type="submit" class="btn btn-primary" value="Submit" />
    </EditForm>
</div>

<div>
    @displayMessage
</div>


@code {
    private RecipeModel recipe = new();
    private HttpResponseMessage response;
    private string displayMessage;

    private async void SubmitRecipe()
    {
        var client = factory.CreateClient("api");
        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", tokenInfo.Token);
        response = await client.PostAsJsonAsync<RecipeModel>("Administrator", recipe);
        if (response.IsSuccessStatusCode)
        {
            displayMessage = "Your recipe has posted.";
        }
        else
        {
            displayMessage = "There was an error posting your submission. You are not authorized to submit a recipe. " +
                             "You must be an admin.";
        }
        await InvokeAsync(StateHasChanged);
    }
}
